---
title: "Get Started with nflplotR"
output: rmarkdown::html_vignette
author: "Sebastian Carl"
vignette: >
  %\VignetteIndexEntry{Get Started with nflplotR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Preface

Working with publicly available NFL data often results in a desire to visualize the findings of one's analyses (often in [ggplot2](https://ggplot2.tidyverse.org)) and then publish these visualizations. In team-level analyses, it appears that such visualizations are more aesthetically pleasing when their logos are used instead of team abbreviations. Another way to visually distinguish teams is to use their primary or secondary team colors.

**nflplotR** provides ggplot2 extensions that greatly simplify these tasks and avoid typical problems.

Long story short: the only thing that is required to use NFL team logos or team colors in a ggplot is a variable in the plot data that holds official NFL team abbreviations.

# Typical Use Cases 

Let's look at some typical use cases for nflplotR using NFL play-by-play data. In a first step we load all necessary packages.

```{r setup}
library(nflplotR)
library(ggplot2)
library(nflreadr)
library(dplyr, warn.conflicts = FALSE)
```

We will load the data and compute each team's offensive and defensive EPA per play for the 2020 regular season. 

```{r}
pbp <- nflreadr::load_pbp(2020) %>% 
  dplyr::filter(season_type == "REG") %>%
  dplyr::filter(!is.na(posteam) & (rush == 1 | pass == 1))

offense <- pbp %>%
  dplyr::group_by(team = posteam) %>%
  dplyr::summarise(off_epa = mean(epa, na.rm = TRUE))

defense <- pbp %>%
  dplyr::group_by(team = defteam) %>%
  dplyr::summarise(def_epa = mean(epa, na.rm = TRUE))

combined <- offense %>%
  dplyr::inner_join(defense, by = "team")
```

## Logos as Axis Labels

Let's start with the offense and build a bar chart using logos as axis labels and team colors as bar colors.

```{r}
ggplot2::ggplot(offense, aes(x = team, y = off_epa)) +
  ggplot2::geom_col(aes(color = team, fill = team), width = 0.5) +
  nflplotR::scale_color_nfl(type = "secondary") +
  nflplotR::scale_fill_nfl(alpha = 0.4) +
  nflplotR::scale_x_nfl() +
  ggplot2::labs(
    title = "2020 NFL Offensive EPA per Play",
    y = "Offense EPA/play"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(face = "bold"),
    plot.title.position = "plot",
    # it's obvious what the x-axis is so we remove the title
    axis.title.x = ggplot2::element_blank()
  ) +
  # this line triggers the download of the logos and calls a ggplot theme internally
  # so it must be placed after a theme definition
  nflplotR::theme_x_nfl()
```

Some notes:

* color and fill allow primary or secondary team colors
* the axis labels are replaced with the logos in two steps: 
  - first step is to call `scale_x_nfl()` which replaces the team names with logo urls internally and 
  - second step is to call `theme_x_nfl()` which triggers the actual download of the logos. 
* the team logos are provided by ESPN and it appears that one or more of them are using incorrect sRGB profiles which triggers a warning in the `png` package. It's safe to ignore this.

It is important to note that the call of `theme_x_nfl()` must be placed after a call to a global ggplot theme like `ggplot2::theme_minimal()` because they replace all current theme options.
  
We can do the same thing for the y-axis (now with defensive EPA per play)

```{r}
ggplot2::ggplot(defense, aes(y = team, x = def_epa)) +
  ggplot2::geom_col(aes(color = team, fill = team), width = 0.5) +
  nflplotR::scale_color_nfl(type = "secondary") +
  nflplotR::scale_fill_nfl(alpha = 0.4) +
  nflplotR::scale_y_nfl() +
  ggplot2::labs(
    title = "2020 NFL Defensive EPA per Play",
    x = "Defense EPA/play"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(face = "bold"),
    plot.title.position = "plot",
    # it's obvious what the y-axis is so we remove the title
    axis.title.y = ggplot2::element_blank(),
  ) +
  # this line triggers the download of the logos and calls a ggplot theme internally
  # so it must be placed after a theme definition
  nflplotR::theme_y_nfl()
```

## Logos in Scatter Plots

Offensive and Defensive EPA per Play are typically used for NFL team tiers. Let's create this scatter plot and play around with the capabilities of the logo geom.

```{r}
ggplot2::ggplot(combined, aes(x = off_epa, y = def_epa)) +
  ggplot2::geom_abline(slope = -1.5, intercept = seq(0.4, -0.3, -0.1), alpha = .2) +
  nflplotR::geom_mean_lines(aes(v_var = off_epa , h_var = def_epa)) +
  nflplotR::geom_nfl_logos(aes(team_abbr = team), width = 0.065, alpha = 0.7) +
  ggplot2::labs(
    x = "Offense EPA/play",
    y = "Defense EPA/play",
    caption = "Data: @nflfastR",
    title = "2020 NFL Offensive and Defensive EPA per Play"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(face = "bold"),
    plot.title.position = "plot"
  ) +
  ggplot2::scale_y_reverse()
```

There is a lot going on here:

* we add mean lines for both x-axis and y-axis in a single line,
* we add team logos that are printed in correct aspect ration regardless of plot dimensions and
* we add an alpha channel to the team logos (which can also be done inside an aesthetic which means it can differ for each team).

What if we would like to highlight just a few teams? Well, there are multiple ways to do this. Either set the alpha channel for the irrelevant teams lower or give them a color (or do both). Wait...a color? Yes, it is possible to overwrite the color of logos but keep their shape! Let's do this in the next example. We would like to highlight the NFC East Teams for no specific reason...

```{r}
nfc_east <- c("DAL", "NYG", "PHI", "WAS")

combined %>%
  dplyr::mutate(
    colour = ifelse(team %in% nfc_east, NA, "gray"),
    alpha = ifelse(team %in% nfc_east, 0.9, 0.2)
  ) %>%
  ggplot2::ggplot(aes(x = off_epa, y = def_epa)) +
  ggplot2::geom_abline(slope = -1.5, intercept = seq(0.4, -0.3, -0.1), alpha = .2) +
  nflplotR::geom_mean_lines(aes(v_var = off_epa , h_var = def_epa)) +
  nflplotR::geom_nfl_logos(aes(team_abbr = team, alpha = alpha, colour = colour), width = 0.065) +
  ggplot2::labs(
    x = "Offense EPA/play",
    y = "Defense EPA/play",
    caption = "Data: @nflfastR",
    title = "2020 NFL Offensive and Defensive EPA per Play"
  ) +
  ggplot2::scale_alpha_identity() +
  ggplot2::scale_color_identity() +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(face = "bold"),
    plot.title.position = "plot"
  ) +
  ggplot2::scale_y_reverse()
```

Please note that we have to add `ggplot2::scale_alpha_identity()` and `ggplot2::scale_color_identity()` to our plot in case we are using alphas or colors as aesthetics because we want to use the actual alpha and color values in our data set and not some random defaults!

**This is just a small overview and it is recommended to check the examples provided for each function.**

# How about speed in the RStudio preview pane?

If you are used to preview your plots in RStudio you will probably get a bit impatient if a lot of logos have to be added to a plot because the rendering can take a few seconds. This is what the nflplotR function `ggpreview()` is built for. It saves the plot in a temporary png file and previews it (in it's actual dimensions). Please see the function documentation for further information.
